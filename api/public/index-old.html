<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review Autopilot</title>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      color: #202124;
    }
    
    h1, h2, h3 {
      font-family: 'Google Sans', sans-serif;
    }
    
    .topbar {
      background: white;
      border-bottom: 1px solid #dadce0;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
    }
    
    .topbar-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }
    
    .logo h1 {
      font-size: 22px;
      font-weight: 500;
      color: #202124;
    }
    
    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 24px;
    }
    
    .stats-bar {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
    }
    
    .stat-card {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .stat-icon.reviews { background: #e8f0fe; color: #1967d2; }
    .stat-icon.unanswered { background: #fef7e0; color: #f29900; }
    .stat-icon.queue { background: #e6f4ea; color: #137333; }
    
    .stat-content h3 {
      font-size: 14px;
      font-weight: 500;
      color: #5f6368;
      margin-bottom: 4px;
    }
    
    .stat-content .number {
      font-size: 28px;
      font-weight: 500;
      color: #202124;
      font-family: 'Google Sans', sans-serif;
    }
    
    .controls {
      background: white;
      border-radius: 8px;
      padding: 16px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
    }
    
    select {
      padding: 10px 16px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      color: #202124;
      background: white;
      cursor: pointer;
      font-family: 'Roboto', sans-serif;
      min-width: 200px;
    }
    
    select:focus {
      outline: none;
      border-color: #1a73e8;
    }
    
    button {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Google Sans', sans-serif;
      transition: all 0.2s;
    }
    
    button:disabled {
      opacity: 0.38;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #1765cc;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
    }
    
    .btn-secondary {
      background: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #f8f9fa;
    }
    
    .reviews-grid {
      display: grid;
      gap: 16px;
    }
    
    .review-card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
      transition: box-shadow 0.2s;
    }
    
    .review-card:hover {
      box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f1f3f4;
    }
    
    .reviewer-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .reviewer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1a73e8 0%, #34a853 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 500;
      font-size: 16px;
    }
    
    .reviewer-details h3 {
      font-size: 16px;
      font-weight: 500;
      color: #202124;
      margin-bottom: 4px;
    }
    
    .rating {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #fbbc04;
      font-size: 18px;
    }
    
    .review-date {
      font-size: 12px;
      color: #5f6368;
    }
    
    .review-text {
      color: #202124;
      line-height: 1.6;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .reply-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
    }
    
    .reply-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .reply-header h4 {
      font-size: 14px;
      font-weight: 500;
      color: #5f6368;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-badge {
      background: linear-gradient(135deg, #a142f4 0%, #667eea 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 12px;
      background: white;
    }
    
    textarea:focus {
      outline: none;
      border-color: #1a73e8;
    }
    
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-generate {
      background: linear-gradient(135deg, #a142f4 0%, #667eea 100%);
      color: white;
    }
    
    .btn-generate:hover:not(:disabled) {
      opacity: 0.9;
    }
    
    .btn-approve {
      background: #34a853;
      color: white;
    }
    
    .btn-approve:hover:not(:disabled) {
      background: #2d9348;
    }
    
    .btn-skip {
      background: white;
      color: #ea4335;
      border: 1px solid #dadce0;
    }
    
    .btn-skip:hover:not(:disabled) {
      background: #fef7e0;
    }
    
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: #34a853;
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 8px 0 rgba(60,64,67,0.3), 0 12px 28px 4px rgba(60,64,67,0.15);
      transition: all 0.2s;
    }
    
    .fab:hover:not(:disabled) {
      box-shadow: 0 8px 16px 0 rgba(60,64,67,0.3), 0 16px 32px 8px rgba(60,64,67,0.15);
      transform: translateY(-2px);
    }
    
    .fab-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ea4335;
      color: white;
      border-radius: 12px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 500;
      min-width: 24px;
      text-align: center;
    }
    
    .snackbar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #323232;
      color: white;
      padding: 14px 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.3);
      transition: transform 0.3s;
      z-index: 1000;
    }
    
    .snackbar.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .snackbar.success { background: #34a853; }
    .snackbar.error { background: #ea4335; }
    
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 64px 24px;
      color: #5f6368;
    }
    
    .empty-state .material-icons {
      font-size: 96px;
      color: #dadce0;
      margin-bottom: 16px;
    }
    
    .empty-state h2 {
      font-size: 24px;
      color: #202124;
      margin-bottom: 8px;
    }
    
    .empty-state p {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-content">
      <div class="logo">
        <div class="logo-icon">ü¶Å</div>
        <h1>Review Autopilot</h1>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn-secondary" onclick="window.location.reload()">
          <span class="material-icons" style="font-size: 18px;">refresh</span>
          Oppdater
        </button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <div class="stats-bar">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon reviews">
            <span class="material-icons">rate_review</span>
          </div>
          <div class="stat-content">
            <h3>Totalt</h3>
            <div class="number" id="total-reviews">-</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon unanswered">
            <span class="material-icons">pending</span>
          </div>
          <div class="stat-content">
            <h3>Ubesvarte</h3>
            <div class="number" id="unanswered-reviews">-</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon queue">
            <span class="material-icons">done_all</span>
          </div>
          <div class="stat-content">
            <h3>Godkjent</h3>
            <div class="number" id="queue-count">0</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="controls">
      <select id="business-select">
        <option value="essa">ESSA</option>
        <option value="vespa">Vespa & Humla</option>
        <option value="smash">Smash House</option>
        <option value="blokk">BLOKK Asker</option>
      </select>
      <button class="btn-primary" onclick="loadReviews()">
        <span class="material-icons" style="font-size: 18px;">download</span>
        Last inn reviews
      </button>
      <button class="btn-secondary" onclick="generateAll()" id="generate-all-btn" disabled>
        <span class="material-icons" style="font-size: 18px;">auto_awesome</span>
        Generer alle
      </button>
    </div>
    
    <div class="reviews-grid" id="reviews-container">
      <div class="empty-state">
        <span class="material-icons">inbox</span>
        <h2>Velg en bedrift</h2>
        <p>Last inn reviews for √• komme i gang</p>
      </div>
    </div>
  </div>
  
  <button class="fab" onclick="postAll()" id="fab-post" disabled>
    <span class="material-icons">send</span>
    <span class="fab-badge" id="fab-badge" style="display: none;">0</span>
  </button>
  
  <div class="snackbar" id="snackbar"></div>
  
  <script>
    let currentReviews = [];
    let approvedCount = 0;
    
    async function loadReviews() {
      const business = document.getElementById('business-select').value;
      const container = document.getElementById('reviews-container');
      
      container.innerHTML = `
        <div class="empty-state">
          <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
          <p>Laster reviews...</p>
        </div>
      `;
      
      try {
        console.log('Fetching reviews for:', business);
        const res = await fetch(\`/api/reviews/\${business}\`);
        
        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }
        
        const data = await res.json();
        console.log('Received data:', data);
        
        currentReviews = data.reviews || [];
        
        document.getElementById('total-reviews').textContent = data.total || 0;
        document.getElementById('unanswered-reviews').textContent = data.unanswered || 0;
        document.getElementById('generate-all-btn').disabled = currentReviews.length === 0;
        
        if (currentReviews.length === 0) {
          console.log('No reviews to display');
          container.innerHTML = \`
            <div class="empty-state">
              <span class="material-icons">check_circle</span>
              <h2>Alle reviews besvart!</h2>
              <p>Ingen ubesvarte reviews funnet</p>
            </div>
          \`;
          return;
        }
        
        console.log('Rendering', currentReviews.length, 'reviews');
        container.innerHTML = currentReviews.map((review, i) => {
          const initial = review.reviewer.charAt(0).toUpperCase();
          const stars = getRatingNumber(review.rating);
          
          return \`
            <div class="review-card" data-index="\${i}">
              <div class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-avatar">\${initial}</div>
                  <div class="reviewer-details">
                    <h3>\${review.reviewer}</h3>
                    <div class="rating">
                      \${'<span class="material-icons" style="font-size: 18px;">star</span>'.repeat(stars)}
                    </div>
                  </div>
                </div>
                <div class="review-date">\${new Date(review.createTime).toLocaleDateString('no')}</div>
              </div>
              
              <div class="review-text">\${review.comment}</div>
              
              <div class="reply-section">
                <div class="reply-header">
                  <h4>
                    <span class="material-icons" style="font-size: 18px;">reply</span>
                    Ditt svar
                  </h4>
                  <span class="ai-badge">‚ú® AI</span>
                </div>
                
                <textarea id="reply-\${i}" placeholder="Klikk 'Generer svar' for √• f√• et AI-forslag basert p√• ekte ESSA-stemme"></textarea>
                
                <div class="actions">
                  <button class="btn-generate" onclick="generateOne(\${i})">
                    <span class="material-icons" style="font-size: 18px;">auto_awesome</span>
                    Generer svar
                  </button>
                  <button class="btn-approve" onclick="approve(\${i})" disabled id="approve-\${i}">
                    <span class="material-icons" style="font-size: 18px;">check</span>
                    Godkjenn
                  </button>
                  <button class="btn-skip" onclick="skip(\${i})">
                    <span class="material-icons" style="font-size: 18px;">close</span>
                    Hopp over
                  </button>
                </div>
              </div>
            </div>
          \`;
        }).join('');
        
      } catch (err) {
        console.error('Error loading reviews:', err);
        showSnackbar('Feil ved lasting: ' + err.message, 'error');
        container.innerHTML = \`
          <div class="empty-state">
            <span class="material-icons" style="color: #ea4335;">error</span>
            <h2>Feil ved lasting</h2>
            <p>\${err.message}</p>
          </div>
        \`;
      }
    }
    
    function getRatingNumber(rating) {
      const map = { FIVE: 5, FOUR: 4, THREE: 3, TWO: 2, ONE: 1 };
      return map[rating] || 0;
    }
    
    async function generateOne(index) {
      console.log('Generating reply for index:', index);
      const review = currentReviews[index];
      const textarea = document.getElementById(\`reply-\${index}\`);
      const btn = event.target.closest('button');
      
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner"></div> Genererer...';
      
      try {
        console.log('Sending review to API:', review);
        const res = await fetch('/api/generate-reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(review)
        });
        
        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }
        
        const data = await res.json();
        console.log('Received reply:', data);
        
        if (data.success) {
          textarea.value = data.reply;
          document.getElementById(\`approve-\${index}\`).disabled = false;
          showSnackbar('Svar generert!', 'success');
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (err) {
        console.error('Generate error:', err);
        showSnackbar('Feil: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons" style="font-size: 18px;">auto_awesome</span> Generer svar';
      }
    }
    
    async function generateAll() {
      for (let i = 0; i < currentReviews.length; i++) {
        await generateOne(i);
        await new Promise(r => setTimeout(r, 300));
      }
      showSnackbar('Alle svar generert!', 'success');
    }
    
    async function approve(index) {
      const review = currentReviews[index];
      const reply = document.getElementById(\`reply-\${index}\`).value;
      const business = document.getElementById('business-select').value;
      
      if (!reply.trim()) {
        showSnackbar('Kan ikke godkjenne tomt svar', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/approve-reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reviewId: review.id, reply, business })
        });
        
        const data = await res.json();
        approvedCount = data.queueSize;
        
        document.getElementById('queue-count').textContent = approvedCount;
        document.getElementById('fab-post').disabled = approvedCount === 0;
        document.getElementById('fab-badge').style.display = approvedCount > 0 ? 'block' : 'none';
        document.getElementById('fab-badge').textContent = approvedCount;
        
        document.querySelector(\`[data-index="\${index}"]\`).remove();
        
        showSnackbar('Lagt til i k√∏!', 'success');
        
      } catch (err) {
        showSnackbar('Feil: ' + err.message, 'error');
      }
    }
    
    function skip(index) {
      document.querySelector(\`[data-index="\${index}"]\`).remove();
      showSnackbar('Hoppet over');
    }
    
    async function postAll() {
      if (!confirm(\`Post \${approvedCount} svar til Google Business?\`)) return;
      
      showSnackbar('Poster til Google...', 'success');
      
      setTimeout(() => {
        showSnackbar('Alle svar postet!', 'success');
        approvedCount = 0;
        document.getElementById('queue-count').textContent = '0';
        document.getElementById('fab-badge').style.display = 'none';
        document.getElementById('fab-post').disabled = true;
      }, 2000);
    }
    
    function showSnackbar(message, type = 'success') {
      const snackbar = document.getElementById('snackbar');
      snackbar.textContent = message;
      snackbar.className = 'snackbar ' + type;
      snackbar.classList.add('show');
      
      setTimeout(() => {
        snackbar.classList.remove('show');
      }, 3000);
    }
    
    loadReviews();
  </script>
</body>
</html>
