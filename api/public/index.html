<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review Autopilot - ESSA</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      padding: 20px;
    }
    
    .container { max-width: 1000px; margin: 0 auto; }
    
    .header {
      margin-bottom: 30px;
    }
    
    .logo {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .logo .highlight { color: #10b981; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #333;
    }
    
    .stat-label {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #10b981;
    }
    
    .stat-value.warning { color: #f59e0b; }
    
    .section-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .badge {
      background: #ef4444;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .reviews { display: flex; flex-direction: column; gap: 20px; }
    
    .review-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 24px;
      position: relative;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .reviewer {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .reviewer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .reviewer-info h3 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }
    
    .reviewer-meta {
      font-size: 0.85rem;
      color: #888;
    }
    
    .stars {
      color: #f59e0b;
      font-size: 1.2rem;
    }
    
    .review-text {
      background: #0f0f0f;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      border-left: 3px solid #333;
    }
    
    .response-section {
      background: #0f0f0f;
      padding: 16px;
      border-radius: 8px;
      border-left: 3px solid #10b981;
    }
    
    .response-label {
      font-size: 0.85rem;
      color: #10b981;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .response-text {
      color: #e5e5e5;
      line-height: 1.6;
      margin-bottom: 16px;
      min-height: 60px;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-approve {
      background: #10b981;
      color: white;
    }
    
    .btn-approve:hover {
      background: #059669;
    }
    
    .btn-generate {
      background: #3b82f6;
      color: white;
    }
    
    .btn-generate:hover {
      background: #2563eb;
    }
    
    .btn-generate:disabled {
      background: #333;
      cursor: not-allowed;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    
    .spinner {
      border: 3px solid #333;
      border-top-color: #10b981;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }
    
    .empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }
    
    select {
      background: #1a1a1a;
      color: #e5e5e5;
      border: 1px solid #333;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">Restaurant<span class="highlight">Autopilot</span></div>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Totalt anmeldelser</div>
        <div class="stat-value" id="total">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Venter p√• svar</div>
        <div class="stat-value warning" id="unanswered">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Snittrating</div>
        <div class="stat-value" id="rating">-</div>
      </div>
    </div>
    
    <select id="business-select">
      <option value="essa">ESSA</option>
      <option value="vespa">Vespa & Humla</option>
      <option value="smash">Smash House</option>
      <option value="blokk">BLOKK Asker</option>
    </select>
    
    <div class="section-title">
      Anmeldelser som trenger svar
      <span class="badge" id="badge">0</span>
    </div>
    
    <div id="reviews" class="reviews">
      <div class="loading">
        <div class="spinner"></div>
        <div>Laster reviews...</div>
      </div>
    </div>
  </div>
  
  <script>
    let currentBusiness = 'essa';
    
    document.getElementById('business-select').addEventListener('change', (e) => {
      currentBusiness = e.target.value;
      loadReviews();
    });
    
    async function loadReviews() {
      const container = document.getElementById('reviews');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Laster reviews...</div></div>';
      
      try {
        const res = await fetch(`/api/reviews/${currentBusiness}`);
        const data = await res.json();
        
        document.getElementById('total').textContent = data.total;
        document.getElementById('unanswered').textContent = data.unanswered;
        document.getElementById('badge').textContent = data.unanswered;
        
        // Calculate average rating
        const avgRating = data.reviews.length > 0 
          ? (data.reviews.reduce((sum, r) => sum + (r.starRating === 'FIVE' ? 5 : r.starRating === 'FOUR' ? 4 : r.starRating === 'THREE' ? 3 : r.starRating === 'TWO' ? 2 : 1), 0) / data.reviews.length).toFixed(1)
          : '-';
        document.getElementById('rating').textContent = avgRating;
        
        if (data.reviews.length === 0) {
          container.innerHTML = '<div class="empty"><div class="empty-icon">‚úì</div><h2>Alle reviews besvart!</h2><p>Ingen ubesvarte reviews funnet</p></div>';
          return;
        }
        
        container.innerHTML = data.reviews.map(review => {
          const initials = review.reviewer.displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          const stars = '‚≠ê'.repeat(review.starRating === 'FIVE' ? 5 : review.starRating === 'FOUR' ? 4 : review.starRating === 'THREE' ? 3 : review.starRating === 'TWO' ? 2 : 1);
          
          return `
            <div class="review-card" data-review-id="${review.reviewId || review.name}">
              <div class="review-header">
                <div class="reviewer">
                  <div class="reviewer-avatar">${initials}</div>
                  <div class="reviewer-info">
                    <h3>${review.reviewer.displayName}</h3>
                    <div class="reviewer-meta">${new Date(review.createTime).toLocaleDateString('no')} ¬∑ Google</div>
                  </div>
                </div>
                <div class="stars">${stars}</div>
              </div>
              <div class="review-text">${review.comment}</div>
              <div class="response-section">
                <div class="response-label">‚ú® AI-generert svar</div>
                <div class="response-text" id="response-${review.reviewId || review.name}">
                  <em style="color: #888;">Klikk "Generer svar" for √• lage et AI-drevet svar...</em>
                </div>
                <div class="actions">
                  <button class="btn btn-generate" onclick="generateReply('${review.reviewId || review.name}', '${review.starRating}', \`${review.comment.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${review.reviewer.displayName}')">
                    ‚ú® Generer svar
                  </button>
                  <button class="btn btn-approve" style="display:none;">
                    ‚úì Godkjenn & publiser
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        container.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><h2>Feil ved lasting</h2><p>${err.message}</p></div>`;
      }
    }
    
    async function generateReply(reviewId, rating, comment, reviewerName) {
      const btn = event.target;
      const responseEl = document.getElementById(`response-${reviewId}`);
      const approveBtn = btn.parentElement.querySelector('.btn-approve');
      
      btn.disabled = true;
      btn.textContent = 'Genererer...';
      responseEl.innerHTML = '<div style="color: #888;">AI tenker... ü§î</div>';
      
      try {
        const res = await fetch('/api/generate-reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            business: currentBusiness,
            rating,
            comment,
            reviewerName
          })
        });
        
        const data = await res.json();
        
        if (data.reply) {
          responseEl.textContent = data.reply;
          btn.style.display = 'none';
          approveBtn.style.display = 'inline-block';
        } else {
          responseEl.innerHTML = '<em style="color: #ef4444;">Kunne ikke generere svar</em>';
          btn.disabled = false;
          btn.textContent = '‚ú® Generer svar';
        }
        
      } catch (err) {
        responseEl.innerHTML = `<em style="color: #ef4444;">Feil: ${err.message}</em>`;
        btn.disabled = false;
        btn.textContent = '‚ú® Generer svar';
      }
    }
    
    // Load on page load
    loadReviews();
  </script>
</body>
</html>
